<!DOCTYPE html>
<html>
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
		<title>Tearing Test</title>
		
</head>
<body>
	<canvas id="myCanvas" style="position: fixed; top: 0; left: 0;">			
	</canvas>

	<script type="text/javascript">

		var canvas=document.getElementById("myCanvas");
		var backbufferContext2d = document.createElement("canvas").getContext("2d");
		var context2d=canvas.getContext("2d");	
		var viewportHeight = null;
		var viewportWidth = null;
		var lineWidth=null;
		var lineSpeed=null;
		var float_x, x;
		var initialTime=null;
		var nowTime=null;


		window.requestAnimationFrame(mainLoop);
		
		function mainLoop(timestamp){
			updateTimeVariables(timestamp);
			updateViewportSize();
			float_x = (lineSpeed*getDeltaTime()) % (viewportWidth+lineWidth*3);
			x=Math.floor(float_x);
			drawBackground();
			drawTearingLines();
			render();
			window.requestAnimationFrame(mainLoop);
		}
		
		function render() {
		  context2d.drawImage(backbufferContext2d.canvas, 0, 0);
		}

		function updateViewportSize(){
			var windowWidth = window.innerWidth;
			var windowHeight = window.innerHeight;
			var changed=false;
			if(windowWidth!=viewportWidth){
				viewportWidth = windowWidth;
				backbufferContext2d.canvas.width  = viewportWidth;
				context2d.canvas.width  = viewportWidth;
				changed=true;
			}
			if(windowHeight!=viewportHeight){
				viewportHeight = windowHeight;
				backbufferContext2d.canvas.height  = viewportHeight;
				context2d.canvas.height  = viewportHeight;
				changed=true;
			}
			if(changed){
				console.log("ViewportSizeChanged")
				onViewportSizeChanged();
			}
		}
		
		function onViewportSizeChanged(){
			lineWidth=Math.floor(viewportWidth*0.01);
			lineSpeed=lineWidth*0.015;
		}

		function updateTimeVariables(timestamp){
			if(!initialTime) 
				initialTime=timestamp;
			nowTime=timestamp;
		}
		
		function getDeltaTime(){
			return nowTime-initialTime;
		}

		function drawBackground(){
			backbufferContext2d.fillStyle = "#000000";
			backbufferContext2d.fillRect(0,0,viewportWidth,viewportHeight);
		}

		function drawTearingLines(){
			backbufferContext2d.fillStyle = "#FF0000";		
			backbufferContext2d.fillRect(x-lineWidth,0,lineWidth,viewportHeight);
			backbufferContext2d.fillRect(x-3*lineWidth,0,lineWidth,viewportHeight);
		}

	</script>
</body>	
</html>